<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Megan AI - Offline Project Assistant</title>
    <style>
      :root {
        --primary: #6e48aa;
        --secondary: #9d50bb;
        --accent: #4776e6;
        --bg: #f8f9fa;
        --text: #333;
        --light: #fff;
        --dark: #1a1a1a;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
        background-color: var(--bg);
        color: var(--text);
      }

      .container {
        display: grid;
        grid-template-columns: 300px 1fr;
        height: 100vh;
      }

      .sidebar {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        padding: 20px;
        overflow-y: auto;
      }

      .main-content {
        display: grid;
        grid-template-rows: auto 1fr auto;
        padding: 20px;
      }

      .project-tree {
        margin-top: 20px;
      }

      .chat-container {
        background-color: var(--light);
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 20px;
        overflow-y: auto;
        max-height: 60vh;
      }

      .message {
        margin-bottom: 15px;
        padding: 10px 15px;
        border-radius: 18px;
        max-width: max-content;
      }

      .user-message {
        background-color: var(--accent);
        color: var(--light);
        margin-left: auto;
        border-bottom-right-radius: 5px;
      }

      .ai-message {
        background-color: #f1f1f1;
        margin-right: auto;
        border-bottom-left-radius: 5px;
      }

      .input-area {
        display: flex;
        gap: 10px;
      }

      input[type="text"] {
        flex: 1;
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 24px;
        font-size: 16px;
      }

      button {
        background-color: var(--accent);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 24px;
        cursor: pointer;
        font-weight: bold;
        margin: 2px;
      }

      .suggestions {
        margin-top: 20px;
      }

      .suggestion-card {
        background-color: var(--light);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        display: table-header-group;
      }

      .suggestion-card.error {
        background-color: #ffebee;
        color: #c62828;
      }

      .status-bar {
        font-size: 12px;
        color: #666;
        text-align: right;
        padding: 5px;
      }

      /* Code Editor Styles */
      #code-editor {
        position: fixed;
        top: 0;
        right: 0;
        width: 50%;
        height: 100%;
        background-color: var(--light);
        box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
        z-index: 100;
        display: none;
        flex-direction: column;
        padding: 20px;
        box-sizing: border-box;
      }

      #code-editor.visible {
        display: flex;
      }

      .editor-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
      }

      #editor-content {
        flex: 1;
        font-family: "Consolas", "Monaco", monospace;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
        resize: none;
        background-color: #f8f8f8;
        white-space: pre;
        overflow-x: auto;
      }

      .file-item {
        cursor: pointer;
        padding: 5px;
        border-radius: 3px;
      }

      .file-item:hover {
        background-color: rgba(255, 255, 255, 0.1);
      }

      /* Health Dashboard Styles */
      #health-dashboard {
        display: inline-table;
        background-color: var(--light);
        border-radius: 8px;
        padding: 15px;
        margin-top: 20px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        font-size: 11px;
        color: var(--text); /* Fixed text color */
      }

      .metrics {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-top: 10px;
      }

      .metric {
        padding: 10px;
      }

      .metric h4 {
        margin-top: 0;
        margin-bottom: 10px;
      }

      .progress-bar {
        height: 10px;
        background-color: #e0e0e0;
        border-radius: 5px;
        overflow: hidden;
      }

      .progress {
        height: 100%;
        transition: width 0.5s ease;
      }

      /* Dropdown Styles */
      .dropdown {
        margin-bottom: 15px;
      }

      .dropdown-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 15px;
        background-color: var(--light);
        border-radius: 8px;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        font-weight: bold;
      }

      .dropdown-header:hover {
        background-color: #f1f1f1;
      }

      .dropdown-arrow {
        transition: transform 0.3s ease;
      }

      .dropdown-arrow.rotated {
        transform: rotate(180deg);
      }

      .dropdown-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease, padding 0.3s ease;
        background-color: var(--light);
        border-radius: 0 0 8px 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }

      .dropdown-content.expanded {
        max-height: 1000px;
        padding: 15px;
        margin-top: 5px;
      }
      
      /* Close button styles */
      #close-editor {
        background-color: #f44336;
        margin-left: 10px;
      }

      #close-editor:hover {
        background-color: #d32f2f;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="sidebar">
        <h2>Megan AI</h2>
        <p>Offline Project Assistant</p>

        <div class="project-tree">
          <h3>Project Structure</h3>
          <div id="project-structure">
            <!-- Dynamically loaded project files -->
          </div>
        </div>

        <div class="project-actions">
          <button id="scan-project">Rescan Project</button>
          <button id="analyze-project">Analyze for Improvements</button>
        </div>

        <!-- Health Dashboard -->
        <div id="health-dashboard">
          <h3>Project Health</h3>
          <div class="metrics">
            <div class="metric" id="code-quality">
              <h4>Code Quality</h4>
              <div class="progress-bar"><div class="progress"></div></div>
            </div>
            <div class="metric" id="performance">
              <h4>Performance</h4>
              <div class="progress-bar"><div class="progress"></div></div>
            </div>
            <div class="metric" id="best-practices">
              <h4>Best Practices</h4>
              <div class="progress-bar"><div class="progress"></div></div>
            </div>
          </div>
        </div>
      </div>

      <div class="main-content">
        <div class="chat-container" id="chat-container">
          <div class="message ai-message">
            Hello! I'm Megan AI, your offline project assistant. I've scanned
            your project and I'm ready to help with improvements, code
            suggestions, and debugging.
          </div>
        </div>

        <div class="suggestions">
          <div class="dropdown">
            <div class="dropdown-header" id="suggestions-dropdown">
              <span>Suggested Improvements</span>
              <span class="dropdown-arrow">â–¼</span>
            </div>
            <div class="dropdown-content" id="suggestions-list">
              <!-- AI suggestions will appear here -->
            </div>
          </div>
        </div>

        <div class="input-area">
          <input
            type="text"
            id="user-input"
            placeholder="Ask Megan about your project..."
          />
          <button id="send-button">Send</button>
        </div>

        <div class="status-bar">
          <span id="status">Ready | Response time: 120ms</span>
        </div>
      </div>
    </div>

    <!-- Code Editor Panel -->
    <div id="code-editor">
      <div class="editor-header">
        <span id="filename">Editing: project/index.js</span>
        <div>
          <button id="save-changes">Save Changes</button>
          <button id="close-editor">Close</button>
        </div>
      </div>
      <textarea id="editor-content"></textarea>
    </div>

    <script>
      // Connect to Ollama backend
      const ollamaEndpoint = "http://localhost:11434/api/chat";
      let chatContext = [];

      // Project scanning functionality
      document
        .getElementById("scan-project")
        .addEventListener("click", async () => {
          document.getElementById("status").textContent = "Scanning project...";

          try {
            const response = await fetch("/scan-project", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
            });

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            if (data.success) {
              renderProjectStructure(data.structure);
              document.getElementById("status").textContent =
                "Project scanned | Ready";
              addMessage(
                "I've rescanned your project structure.",
                "ai-message"
              );
            } else {
              throw new Error(data.error || "Scan failed");
            }
          } catch (error) {
            document.getElementById("status").textContent =
              "Error scanning project";
            addMessage(
              "Sorry, I couldn't rescan the project. Please try again.",
              "ai-message"
            );
            console.error("Scan error:", error);
          }
        });

      // Analyze project for improvements
      document
        .getElementById("analyze-project")
        .addEventListener("click", async () => {
          document.getElementById("status").textContent =
            "Analyzing project...";
          document.getElementById("suggestions-list").innerHTML =
            '<div class="suggestion-card">Analyzing project files...</div>';

          try {
            const response = await fetch("/analyze-project", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
            });

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            if (data.success) {
              const suggestionsHTML = data.suggestions
                .map(
                  (suggestion) =>
                    `<div class="suggestion-card">${suggestion}</div>`
                )
                .join("");
              document.getElementById("suggestions-list").innerHTML =
                suggestionsHTML;
              document.getElementById("status").textContent =
                "Analysis complete | Ready";

              addMessage(
                "I've analyzed your project. Here are my suggestions:\n" +
                  data.suggestions.join("\n"),
                "ai-message"
              );
              chatContext.push({
                role: "assistant",
                content:
                  "I've analyzed your project and provided suggestions in the suggestions panel.",
              });
            } else {
              throw new Error(data.error || "Analysis failed");
            }
          } catch (error) {
            document.getElementById("status").textContent =
              "Error analyzing project";
            document.getElementById(
              "suggestions-list"
            ).innerHTML = `<div class="suggestion-card error">Error: ${error.message}</div>`;
            addMessage(
              "Sorry, I encountered an error while analyzing your project.",
              "ai-message"
            );
            console.error("Analysis error:", error);
          }
        });

      // Chat functionality
      document
        .getElementById("send-button")
        .addEventListener("click", sendMessage);
      document
        .getElementById("user-input")
        .addEventListener("keypress", (e) => {
          if (e.key === "Enter") sendMessage();
        });

      async function sendMessage() {
        const userInput = document.getElementById("user-input").value;
        if (!userInput.trim()) return;

        // Add user message to chat and context
        addMessage(userInput, "user-message");
        chatContext.push({ role: "user", content: userInput });
        document.getElementById("user-input").value = "";
        document.getElementById("status").textContent = "Megan is thinking...";

        try {
          const startTime = performance.now();

          // Send to Ollama
          const response = await fetch("/ask-megan", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              message: userInput,
              context: chatContext.slice(-6),
            }),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          const endTime = performance.now();
          const responseTime = Math.round(endTime - startTime);

          addMessage(data.response, "ai-message");
          chatContext.push({ role: "assistant", content: data.response });
          document.getElementById(
            "status"
          ).textContent = `Ready | Response time: ${responseTime}ms`;
        } catch (error) {
          document.getElementById("status").textContent =
            "Error getting response";
          addMessage(
            "Sorry, I encountered an error. Please try again.",
            "ai-message"
          );
          console.error("Chat error:", error);
        }
      }

      function addMessage(content, className) {
        const chatContainer = document.getElementById("chat-container");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${className}`;
        messageDiv.textContent = content;
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      function renderProjectStructure(structure) {
        const container = document.getElementById("project-structure");
        container.innerHTML = "";

        function createTree(items, parentElement) {
          const ul = document.createElement("ul");
          items.forEach((item) => {
            const li = document.createElement("li");
            const span = document.createElement("span");
            span.className = "file-item";
            span.textContent = item.name;

            // Add click handler to open files in editor
            if (item.type === "file") {
              span.onclick = () => openFile(item.path);
              span.style.cursor = "pointer";
              span.style.color = "#ffeb3b";
            } else {
              span.style.cursor = "default";
              span.style.color = "white";
            }

            li.appendChild(span);
            if (item.children && item.children.length > 0) {
              createTree(item.children, li);
            }
            ul.appendChild(li);
          });
          parentElement.appendChild(ul);
        }

        createTree(structure, container);
      }

      function renderSuggestions(suggestions) {
        const container = document.getElementById("suggestions-list");
        container.innerHTML = "";

        suggestions.forEach((suggestion) => {
          const card = document.createElement("div");
          card.className = "suggestion-card";
          card.textContent = suggestion;
          container.appendChild(card);
        });
      }

      // File handling functions
      async function openFile(filepath) {
        try {
          const response = await fetch("/get-file", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ filepath }),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          if (data.success) {
            openFileEditor(filepath, data.content);
          } else {
            throw new Error(data.error || "Failed to open file");
          }
        } catch (error) {
          console.error("Error opening file:", error);
          addMessage(
            `Sorry, I couldn't open ${filepath}. Error: ${error.message}`,
            "ai-message"
          );
        }
      }

      function openFileEditor(filepath, content) {
        // Extract just the filename for display
        const filename = filepath.split(path.sep).pop();
        document.getElementById(
          "filename"
        ).textContent = `Editing: ${filename}`;
        document.getElementById("editor-content").value = content;
        document.getElementById("code-editor").classList.add("visible");

        // Store the full path in a data attribute
        document.getElementById("code-editor").dataset.filepath = filepath;
      }

      function closeFileEditor() {
        document.getElementById("code-editor").classList.remove("visible");
      }

      async function saveFileChanges() {
        const filepath =
          document.getElementById("code-editor").dataset.filepath;
        const newContent = document.getElementById("editor-content").value;

        if (!filepath) {
          addMessage("Error: No file path found for saving.", "ai-message");
          return;
        }

        try {
          const response = await fetch("/save-file", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ filepath, content: newContent }),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          if (data.success) {
            addMessage(
              `Successfully saved changes to ${filepath}`,
              "ai-message"
            );
            closeFileEditor();
          } else {
            throw new Error(data.error || "Failed to save file");
          }
        } catch (error) {
          console.error("Error saving file:", error);
          addMessage(
            `Sorry, I couldn't save ${filepath}. Error: ${error.message}`,
            "ai-message"
          );
        }
      }

      // Health check functions
      async function checkProjectHealth() {
        try {
          const response = await fetch("/project-health");
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const health = await response.json();

          updateHealthMetric("code-quality", health.codeQuality);
          updateHealthMetric("performance", health.performance);
          updateHealthMetric("best-practices", health.bestPractices);
        } catch (error) {
          console.error("Error checking project health:", error);
        }
      }

      function updateHealthMetric(elementId, score) {
        const element = document
          .getElementById(elementId)
          .querySelector(".progress");
        element.style.width = `${score}%`;
        element.style.backgroundColor =
          score > 70 ? "#4CAF50" : score > 40 ? "#FFC107" : "#F44336";
      }

      // Load initial project structure
      async function loadInitialProjectStructure() {
        try {
          const response = await fetch("/initial-structure");
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          if (data.success) {
            renderProjectStructure(data.structure);
            document.getElementById("status").textContent =
              "Project loaded | Ready";
          } else {
            throw new Error(data.error || "Failed to load project structure");
          }
        } catch (error) {
          console.error("Error loading initial structure:", error);
          document.getElementById("status").textContent =
            "Error loading project";

          // Show empty project structure with message
          const container = document.getElementById("project-structure");
          container.innerHTML =
            '<div style="color: #ffeb3b; padding: 10px;">Click "Rescan Project" to load files</div>';
        }
      }

      // Toggle dropdown functionality
      document
        .getElementById("suggestions-dropdown")
        .addEventListener("click", function () {
          const content = document.getElementById("suggestions-list");
          const arrow = this.querySelector(".dropdown-arrow");

          content.classList.toggle("expanded");
          arrow.classList.toggle("rotated");
        });

      // Keyboard shortcuts
      document.addEventListener("keydown", (e) => {
        // Ctrl+Enter to send message
        if (e.ctrlKey && e.key === "Enter") {
          sendMessage();
        }

        // Escape to clear input
        if (e.key === "Escape") {
          document.getElementById("user-input").value = "";
        }

        // Ctrl+Shift+A to analyze
        if (e.ctrlKey && e.shiftKey && e.key === "A") {
          document.getElementById("analyze-project").click();
        }
        
        // Escape to close editor if it's open
        if (e.key === "Escape" && document.getElementById("code-editor").classList.contains("visible")) {
          closeFileEditor();
        }
      });

      // Connect save button
      document
        .getElementById("save-changes")
        .addEventListener("click", saveFileChanges);
        
      // Connect close button
      document
        .getElementById("close-editor")
        .addEventListener("click", closeFileEditor);

      // Initialize on page load
      window.addEventListener("DOMContentLoaded", () => {
        // Load actual project structure from server
        loadInitialProjectStructure();

        // Initialize chat context with welcome message
        chatContext.push({
          role: "assistant",
          content:
            "Hello! I'm Megan AI, your offline project assistant. I've scanned your project and I'm ready to help with improvements, code suggestions, and debugging.",
        });

        // Initial health check
        checkProjectHealth();

        // Set up periodic health checks
        setInterval(checkProjectHealth, 300000); // Every 5 minutes
      });

      // Simple path separator utility (since we can't use Node.js path in browser)
      const path = {
        sep: "/",
      };
    </script>
  </body>
</html>